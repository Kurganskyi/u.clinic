# Инструкция по запуску Telegram-бота Uclinic

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения

Скопируйте `.env.example` в `.env` и заполните:

```bash
cp .env.example .env
```

Обязательные переменные:
- `TELEGRAM_BOT_TOKEN` - токен бота от @BotFather
- `BITRIX24_WEBHOOK_URL` - URL вебхука Битрикс24 (формат: `https://your-portal.bitrix24.ru/rest/1/webhook_code/`)
- `TELEGRAM_ADMIN_IDS` - ID администраторов через запятую

### 3. Инициализация базы данных

```bash
# Создать начальную миграцию (если нужно)
alembic revision --autogenerate -m "Initial migration"

# Применить миграции
alembic upgrade head
```

Или используйте автоматическое создание таблиц при первом запуске:
```bash
python -m bot.main
```

### 4. Запуск бота

```bash
python -m bot.main
```

## Настройка Битрикс24

### Исходящие вебхуки

1. Перейдите в Битрикс24 → Настройки → Разработчикам → Другое → Исходящий вебхук
2. Создайте вебхук на события:
   - `ONCRMDEALADD` - создание сделки (записи)
   - `ONCRMDEALUPDATE` - обновление сделки
3. Укажите URL: `http://ваш-сервер:5000/webhook/bitrix24`
4. Установите секрет (опционально) и укажите его в `.env` как `WEBHOOK_SECRET`

### Входящий вебхук (REST API)

1. Перейдите в Битрикс24 → Настройки → Разработчикам → Другое → Входящий вебхук
2. Создайте вебхук с правами доступа к CRM
3. Скопируйте URL и укажите в `.env` как `BITRIX24_WEBHOOK_URL`

## Тестирование

### Локальное тестирование

1. Запустите бота локально
2. Откройте Telegram и найдите вашего бота
3. Отправьте команду `/start`

### Тестирование вебхуков

Можно использовать `curl` для отправки тестового вебхука:

```bash
curl -X POST http://localhost:5000/webhook/bitrix24 \
  -H "Content-Type: application/json" \
  -d '{
    "event": "ONCRMDEALADD",
    "data": {
      "FIELDS": {
        "ID": 12345
      }
    }
  }'
```

## Структура проекта

```
bot/
├── main.py              # Точка входа
├── config.py            # Конфигурация
├── database.py          # Инициализация БД
├── handlers/            # Обработчики команд и событий
│   ├── start.py         # /start, /help
│   ├── notifications.py # Обработка вебхуков и уведомлений
│   ├── reminders.py     # Напоминания за 24ч
│   └── survey.py        # Опросы
├── services/            # Сервисы интеграций
│   ├── bitrix24.py      # Битрикс24 API
│   ├── scheduler.py     # Планировщик задач
│   ├── webhook_server.py # Flask сервер для вебхуков
│   └── yandex_maps.py   # Генерация ссылок Яндекс.Карты
├── models/              # Модели БД
│   ├── user.py
│   ├── appointment.py
│   ├── survey.py
│   └── statistics.py
└── utils/               # Утилиты
    ├── keyboards.py     # Клавиатуры Telegram
    ├── messages.py      # Шаблоны сообщений
    └── errors.py        # Обработка ошибок
```

## Основные функции

✅ Уведомления о записях - автоматическая отправка при создании сделки в Битрикс24  
✅ Напоминания за 24 часа - автоматические напоминания с кнопками подтверждения  
✅ Опросы через 3 дня - сбор оценок и ссылка на Яндекс.Карты при оценке 5  
✅ Интеграция с Битрикс24 - получение данных и обновление статусов  
✅ Планировщик задач - автоматическое планирование напоминаний и опросов  

## Что еще нужно сделать

- [ ] Протестировать и скопировать меню из @Uclinic1Bot
- [ ] Реализовать систему рассылок
- [ ] Добавить детальную статистику
- [ ] Написать unit-тесты
- [ ] Настроить production окружение

## Проблемы и решения

### Бот не отвечает на команды

- Проверьте `TELEGRAM_BOT_TOKEN` в `.env`
- Убедитесь, что бот запущен и нет ошибок в логах

### Вебхуки не приходят

- Проверьте, что вебхук-сервер запущен (порт указан в `WEBHOOK_PORT`)
- Проверьте доступность URL извне (используйте ngrok для локальной разработки)
- Проверьте секрет вебхука, если он настроен

### Ошибки с БД

- Убедитесь, что права доступа на запись в директорию (для SQLite)
- Для PostgreSQL проверьте `DATABASE_URL` и доступность БД

